<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>AdaptiveOpticsControl: AO loop control Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AdaptiveOpticsControl
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_src_AOloopControl_README.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">AO loop control Overview </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This module allows control of adaptive optics (AO) control loops.</p>
<p>Source code in <a class="el" href="AOloopControl_8c.html">AOloopControl.c</a> and <a class="el" href="AOloopControl_8h.html">AOloopControl.h</a></p>
<p>Main features:</p><ul>
<li>uses shared memory to communicate between processes and link to wavefront sensor camera/data and deformable mirrors</li>
<li>multiple loops can run simultaneously, independantly or together</li>
<li>single process can control multiple loops</li>
<li>Can use either CPU(s) or GPU(s) for computations</li>
</ul>
<h1>Top-level script: aolrun</h1>
<p>The top-level script is aolrun.</p>
<p>Script aolrun initializes the control loop by reading configuration input parameters, and then responds to changes in the "wavefront sensor input" image. Control loops are numbered. The loop number is read from local file LOOPNUMBER.</p>
<h2>Required input for aolrun, prior setup</h2>
<p>The following table lists all input / files required prior to running aolrun</p>
<table class="doxtable">
<tr>
<th>Variable Name </th><th>Description </th><th>Setting location  </th></tr>
<tr>
<td>LOOPNUMBER </td><td>loop number [integer] </td><td>local file LOOPNUMBER </td></tr>
<tr>
<td>AOconf[loop].DMname </td><td>shared memory DM image (for correction) </td><td>image aol&lt;LOOPNUMBER&gt;_dmC </td></tr>
<tr>
<td>AOconf[loop].DMnameRM </td><td>shared memory DM image (for response matrix acq) </td><td>image aol&lt;LOOPNUMBER&gt;_dmRM </td></tr>
<tr>
<td>AOconf[loop].WFSname </td><td>shared memory WFS image </td><td>image aol&lt;LOOPNUMBER&gt;_wfs </td></tr>
<tr>
<td>AOconf[loop].DMMODESname </td><td>DM modes </td><td>image aol&lt;LOOPNUMBER&gt;_DMmodes </td></tr>
<tr>
<td>AOconf[loop].respMname </td><td>response matrix </td><td>image aol&lt;LOOPNUMBER&gt;_RespM </td></tr>
<tr>
<td>AOconf[loop].contrMname </td><td>control matrix </td><td>image aol&lt;LOOPNUMBER&gt;_ContrM </td></tr>
<tr>
<td>AOconf[loop].name </td><td>loop name </td><td>local file ./conf/conf_LOOPNAME.txt </td></tr>
<tr>
<td>AOconf[loop].GPU </td><td>number of GPUs used </td><td>local file ./conf/conf_GPU.txt </td></tr>
<tr>
<td>AOconf[loop].GPUall </td><td>skip CPU image scaling and go straight to CPU ? </td><td>local file ./conf/conf_GPUall.txt </td></tr>
<tr>
<td>AOconf[loop].AOLCOMPUTE_TOTAL_ASYNC </td><td>compute image total in separate thread ? </td><td>local file ./conf/conf_COMPUTE_TOTAL_ASYNC.txt </td></tr>
<tr>
<td>MATRIX_COMPUTATION_MODE </td><td>use single combined act-wfs matrix ? </td><td>local file ./conf/conf_CMmode.txt </td></tr>
</table>
<h1>Step-by-step instruction for typical operation</h1>
<p>Control loops are numbered - this is how multiple loops can work together. &lt;LOOPNB&gt; can take any positive integer value (0, 1, 2, etc...)</p>
<p>Important notes:</p><ul>
<li>&lt;executable&gt; is the name given to the executable program</li>
<li>some commands below are stand-alone executable scripts, others are commands to be issued within the main execuatable, which are shown starting with "&gt; ".</li>
<li>stand alone scripts will need to be created if they do not exist: the scripts are provided in this page.</li>
</ul>
<h3>Directories, configurations</h3>
<p>System configurations are saved in independent directories named ./confxxx/.</p>
<p>A configuration consists of:</p><ul>
<li>fmodes.fits : Modes definition</li>
<li>modesfreqcpa.fits : Modes spatial frequency (CPA)</li>
<li>refwfs.fits : WFS reference</li>
<li>respm.fits : Response matrix</li>
<li>cmat.fits : Control matrix</li>
<li>additional control matrixes, named: cmat_&lt;beta&gt;_&lt;nbMrm&gt;.fits<ul>
<li>&lt;beta&gt; is the explonent for low order modes enhancement in the SVD: for example 0.43</li>
<li>&lt;nbMrm&gt; is the number of modes removed (low eigenvalues)</li>
</ul>
</li>
<li>eigenmodesM_&lt;beta&gt;.fits : eigenmodes</li>
<li>eigenmodesrespM_&lt;beta&gt;.fits : WFS response to eigenmodes</li>
<li>TPmask.fits : Telescope pupil mask (optional)</li>
<li>TPind.fits : modes to be removed from control (optional)</li>
</ul>
<p>Scripts are used to load and save configurations as follows: </p><pre class="fragment">./saveconf xxx
./loadconf xxx
</pre><p>saveconf source:</p>
<pre class="fragment">mkdir -p conf$1
cp fmodes.fits ./conf$1/
cp refwfs.fits ./conf$1/
cp respm.fits ./conf$1/
cp cmat.fits ./conf$1/
cp cmat_*_*.fits ./conf$1/
cp AOloop*.conf ./conf$1/
</pre><p>loadconf source:</p>
<pre class="fragment">cp ./conf$1/fmodes.fits .
cp ./conf$1/refwfs.fits .
cp ./conf$1/respm.fits .
cp ./conf$1/cmat.fits .
cp ./conf$1/AOloop*.conf .
</pre><h3>OPTIONAL VARIABLES</h3>
<p>The following variables are optional, and may be specified as command line variable:</p><ul>
<li><p class="startli">AOLCAMDARK: dark level for the camera images. By default, it is assumed that the camera images fed to the software are dark-subtracted. If they are not, it is possible to offset them by a dark value by entering:</p>
<p class="startli">AOLCAMDARK=100.0</p>
</li>
</ul>
<p>It is best to keep optional variable in the CLI startup script, which is automatically executed by the program upon startup. By default, the file name is 'CLIstartup.txt'. It can also be changed and loaded by using the '-s' option when launching the executable. Example startup script: </p><pre class="fragment">aolnb 1
AOLCAMDARK=100.0
</pre><hr/>
<h2>CONFIGURATION</h2>
<h3>(1) CREATE/EDIT AOloop&lt;LOOPNB&gt;.conf</h3>
<p>The configuration for running the AO loop is in this file. Shared memory images names are specified, as well as loop configuration paramaters.</p>
<p>The function <a class="el" href="AOloopControl_8h.html#a5c3b0bdcff0ed83ed3f9f217b14c014d" title="Creates a blank configuration. ">AOloopControl_makeTemplateAOloopconf(long loopnb)</a> creates a template that can be edited: </p><pre class="fragment">&lt;executable&gt;
&gt; aolmkconf &lt;LOOPNB&gt;
</pre><h3>(2) CREATE MODES</h3>
<p>If possible, create the TPmask.fits file which contains the DM illumination. Illuminated actuators are set to 1, others to 0.</p>
<p>For purely Fourier Modes: </p><pre class="fragment">./mkModes &lt;confindex&gt; &lt;CPAmax&gt;
</pre><p>confindex: index for the configuration, for example, 002 will save modes in conf002 directory CPAmax: maximum spatial frequency in the basis of modes, in unit of Cycle Per Aperture.</p>
<p>The mode file name is ./conf&lt;confindex&gt;/fmodes.fits.</p>
<p>This script calls the function AOloopControl_mkModes(char *ID_name, long msize, float CPAmax, float deltaCPA, double xc, double yx, double r0, double r1) in <a class="el" href="AOloopControl_8c.html">AOloopControl.c</a>.</p>
<p>Optional input:</p><ul>
<li>TPmask.fits : telescope pupil mask. If this file is present in the configuration directory, it will be used as a multiplicative mask (with convolotion to avoid sharp transitions) to the modes</li>
<li>TPind.fits : modes to be excluded from the control</li>
</ul>
<p>mkModes source:</p>
<pre class="fragment"># args: &lt;confindex&gt; &lt;maxCPA&gt;
EXPECTED_ARGS=2

if [ $# -ne $EXPECTED_ARGS ]
then
  echo
  echo "-------- create control modes ------------"
  echo "Usage:  $0 &lt;configuration index&gt; &lt;maxCPA&gt;"
  echo "   INPUT:  &lt;configuration index&gt;  : index, 001, 002, 003 etc.."
  echo "   INPUT:  &lt;max CPA&gt;              : maximum spatial frequ [cycles per aperture]"
  echo " EXAMPLE: $0 002 4.0"
  echo
  exit
fi





mkdir -p conf$1

echo "MODES_MAX_CPA      $2" &gt; ./conf$1/fmodes.conf.txt


Cfits &lt;&lt; EOF
loadfits "./conf$1/TPmask.fits" Mmask
loadfits "./conf$1/TPind.fits" emodes
aolmkmodes fmodes 50 $2 0.8 24.5 24.5 21.0 6.5
savefits fmodes "!./conf$1/fmodes.fits"
savefits modesfreqcpa "!./conf$1/modesfreqcpa.fits"
exit
EOF
</pre><h3>(3) FINDING LOOP LATENCY (OPTIONAL)</h3>
<pre class="fragment">./MeasureTD &lt;confindex&gt;
</pre><p>This script will create the "TimeDelayRM.txt", which gives signal strength as a function of frame delay.</p>
<p>The first peak of this curve indicates the time delay and should be updated in the acquRespM script below.</p>
<p>MeasureTD source: </p><pre class="fragment">cp ./conf$1/fmodes.fits .
&lt;executable&gt; &lt;&lt; EOF
aolnb &lt;LOOPNB&gt;
aolacqresp 20 0.05 10 -1 1
exit
EOF
</pre><p>Once the delay is known, edit the acquRespM script (see below) accordingly.</p>
<h3>(4) ACQUIRE RESPONSE MATRIX</h3>
<pre class="fragment">./acquRespM 000
</pre><p>Edit script to change modulation amplitude, number of images per DM state, etc...</p>
<p>This script calls function <a class="el" href="AOloopControl_8h.html#ab51676f77cfd9e45abd24cb0a68a08e7">Measure_Resp_Matrix(long loop, long NbAve, float amp, long nbloop, long fDelay, long NBiter)</a> in module <a class="el" href="AOloopControl_8c.html">AOloopControl.c</a>.</p>
<p>The response matrix acquision will go for a large number of iterations, and data is progressively averaged to improve SNR. The last parameter of the acquRespM command in the script is the number of matrixes averaged. You can either wait for all iterations to complete or CTRL-C the process. If you CTRL-C the process, load the result in the configuration directory: </p><pre class="fragment">cp respm.fits ./conf&lt;xxx&gt;/
cp refwfs.fits ./conf&lt;xxx&gt;/
</pre><p>output: respm.fits, refwfs.fits</p>
<p>acquRespM source: </p><pre class="fragment"># Acquires Response Matrix
# Parameters for aolacqresp are:
# number of images per DM state
# modulation amplitude [um DM displacement]
# number of loop per matrix generation
# frame delay offset [number of frames]
# number of matrixes generated (will be continuously averaged)

# creates files "respm.fits" and "refwfs.fits"

./loadconf $1
&lt;executable&gt; -n aolacqresp&lt;&lt; EOF
aolnb 0
aolacqresp 10 0.02 2 2 100
exit
EOF
cp respm.fits ./conf$1/
cp refwfs.fits ./conf$1/
</pre><h3>(5) COMPUTE CONTROL MATRIXES</h3>
<pre class="fragment">./cmmake &lt;confindex&gt; &lt;beta&gt; &lt;#modes removed&gt;
</pre><p>output: cmat_&lt;beta&gt;_&lt;#modes removed&gt;.fits</p>
<p>Also writes eigenvalues in file "eigenv.dat". Check that number of modes removed is consistent with eigenvalues.</p>
<p>&lt;beta&gt; is the enhancement factor for low order aberrations. For beta=0, there is no enhancement (straight SVD), while beta &gt;0 forces the lowest modes to be low-order. Typical values from 0.50 to 4.00.</p>
<p>cmmake source: </p><pre class="fragment">#
# Make control matrix
# arg 1: configuration directory
# arg 2: Beta coefficient (typically 0.50 to 4.00), enhances low order aberrations for SVD
# arg 3: max number of modes removed

cp ./conf$1/modesfreqcpa.fits .
cp ./conf$1/fmodes.fits .
cp ./conf$1/respm.fits .

&lt;executable&gt; &lt;&lt; EOF
aolnb 0
loadfits respm.fits respm
loadfits fmodes.fits modesM
aolcmmake $3 respm cmat $2
savefits evecM "!evecM.fits"
exit
EOF
mv cmat_*_*.fits ./conf$1/
mv evecM.fits ./conf$1/
mv eigenv.dat ./conf$1/
mv eigenmodesM*.fits ./conf$1/
mv eigenmodesrespM*.fits ./conf$1/
</pre><p>The script calls compute_ControlMatrix(long loop, long NB_MODE_REMOVED, char *ID_Rmatrix_name, char *ID_Cmatrix_name, char *ID_VTmatrix_name, double Beta) in module <a class="el" href="AOloopControl_8c.html">AOloopControl.c</a>.</p>
<hr/>
<h2>RUNNING THE LOOP</h2>
<h3>(6) SET UP / LOAD CONFIGURATION</h3>
<p>Steps above can be repeated to create several configurations. When adopting a configuration:</p><ul>
<li>Choose a control matrix cp conf000/cmat_1.00_003.fits conf000/cmat.fits</li>
<li>load configuration ./loadconf 000</li>
</ul>
<h3>(7) RUN LOOP</h3>
<p>Start TWO instances of the program</p>
<p>In process #1, type : </p><pre class="fragment">&gt; aolnb &lt;LOOPNB&gt;
&gt; aolrun
</pre><p>In process #2, type : </p><pre class="fragment">&gt; aolnb &lt;LOOPNB&gt;
&gt; aolsetgain &lt;loopgain&gt;
&gt; aolon
</pre><p>Other useful commands :</p><ul>
<li>aolsetmaxlim &lt;maximum_value_for_each_mode&gt;</li>
<li>aolsetmultfb &lt;block_number&gt; &lt;multiplicative_factor&gt;</li>
</ul>
<h3>(8) LAUNCH MONITOR</h3>
<p>Start new process, type: </p><pre class="fragment">&gt; aolmon &lt;frequ[Hz]&gt; &lt;number_of_columns&gt;
</pre><p>For each mode, the following info is displayed: </p><pre class="fragment">[&lt;gain_factor&gt; &lt;limit_factor&gt; &lt;multiplier_factor&gt;]   &lt;current_DM_value&gt; &lt;last_WFS_estimate&gt; &lt;average_val&gt; &lt;RMS&gt; 
</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jul 10 2015 21:15:53 for AdaptiveOpticsControl by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
